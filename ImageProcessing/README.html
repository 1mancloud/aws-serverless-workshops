<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>README</title>


<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}

kbd {
  display: inline-block;
  padding: 3px 5px;
  font-size: 11px;
  line-height: 10px;
  color: #555;
  vertical-align: middle;
  background-color: #fcfcfc;
  border: solid 1px #ccc;
  border-bottom-color: #bbb;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #bbb
}

* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>


</head>

<body>

<h1 id="toc_0">Optional Module: Coordinate a serverless image processing workflow with AWS Step Functions</h1>

<p>In this module you&#39;ll use AWS Step Functions to build an image processing workflow by orchestrating multiple AWS Lambda functions. </p>

<p>The Wild Rydes team wants to add a new feature to the app by requiring riders to upload a selfie after signing up. This accomplishes a few things: </p>

<ol>
<li>Allows the unicorns to easily identify the rider during pickup to provide a good customer experience. This also enhances security so bad guys can&#39;t spoof to be riders and get on the unicorns. </li>
<li>Prevents the same user from signing up for multiple accounts to abuse new-user promotions </li>
</ol>

<p><img src="./images/selfie/selfie-picture.jpeg" alt="selfie picture"></p>

<p>When users upload the photo of themselves, a few steps of verification and processing need to take place:</p>

<ol>
<li>Verify the photo shows a clear face the app/unicorns can use to identify the rider </li>
<li>Match against the collection of previously indexed faces to make sure the user hasn&#39;t already signed up</li>
<li>Resize the photo to thumbnails to display on the app</li>
<li>Index the user&#39;s face into the collection so it can be used for matching in the future. </li>
<li>Store the photo metadata with the user&#39;s profile<br></li>
</ol>

<p>In the serverless world, each of steps above can be easily implemented with a AWS Lambda function. But how can we manage the flow of invoking one Lambda function after the previous step has finished and keep track of what happened with each image? What if one of the Lambda function times out and needs to be retried? Some of the Lambda functions can be run in parallel to reduce end-to-end processing latency, how can we coordinate running Lambda functions in parallel and wait for them to finish? AWS Step Functions makes it very easy to solve these problems and provides an audit trail and visualization to track what happened with each flow. </p>

<h2 id="toc_1">Architecture Overview</h2>

<p>The architecture for this module is composed of several AWS Lambda functions that leverage the facial detection capabilities of <strong>Amazon Rekognition</strong>, resize the uploaded image stored in <strong>Amazon S3</strong>, and save the image metadata with the user profile using <strong>Amazon DynamoDB</strong>. The orchestration of these Lambda functions is managed by an <strong>AWS Step Functions</strong>  State Machine.</p>

<p><img src="./images/wild-rydes-architecture.png" width="60%"></p>

<p>Below is the flow diagram of the workflow we will build as visualized by  <strong>AWS Step Functions</strong>:</p>

<p><img src="./images/4th-state-machine-graph.png" width="60%"></p>

<p>In this module, we will manually kick-off processing workflows from the AWS Step Functions management console. In a real world application, you can configure an Amazon API Gateway that your application invokes to trigger the Step Functions state machine, or have it triggered by an Amazon S3 upload event through Amazon CloudWatch Events or S3 event notifications. </p>

<h2 id="toc_2">Implementation Instructions</h2>

<p>Each of the following sections provide an implementation overview and detailed, step-by-step instructions. The overview should provide enough context for you to complete the implementation if you&#39;re already familiar with the AWS Management Console or you want to explore the services yourself without following a walkthrough.</p>

<p>If you&#39;re using the latest version of the Chrome, Firefox, or Safari web browsers the step-by-step instructions won&#39;t be visible until you expand the section.</p>

<p></p></details></p>

<h3 id="toc_3">1. Create a collection in Amazon Rekognition</h3>

<p>A Face Collection is a container in Amazon Rekognition to store indexed face images as searchable vectors.  </p>

<p>Using the AWS CLI commandline tools, create a collection in the Amazon Rekognition called <code>rider-photos</code></p>

<p><details>
<summary><strong>Step-by-step instructions (expand for details)</strong></summary><p></p>

<ol>
<li><p>In a terminal window, run the following command and replace the <code>REPLACE_WITH_YOUR_CHOSEN_AWS_REGION</code> portion with the region string of your chosen region. (see <a href="http://docs.aws.amazon.com/general/latest/gr/rande.html#rekognition_region">Rekognition regions</a>)</p>

<div><pre><code class="language-none">aws rekognition create-collection --region REPLACE_WITH_YOUR_CHOSEN_AWS_REGION --collection-id rider-photos</code></pre></div>

<p>For example:</p>

<div><pre><code class="language-none">aws rekognition create-collection --region us-east-1 --collection-id rider-photos
aws rekognition create-collection --region us-west-2 --collection-id rider-photos
aws rekognition create-collection --region eu-west-1 --collection-id rider-photos</code></pre></div></li>
<li><p>If successful, you should get an acknowledgment from the service that looks like:</p>

<div><pre><code class="language-none">{
    &quot;CollectionArn&quot;: &quot;aws:rekognition:us-west-2:012345678912:collection/rider-photos&quot;,
    &quot;StatusCode&quot;: 200
}</code></pre></div>

<p></p></details></p></li>
</ol>

<h3 id="toc_4">2. Deploy Amazon S3, AWS Lambda and Amazon DynamoDB resources using AWS CloudFormation</h3>

<p>The following AWS CloudFormation template will create these resources:</p>

<ul>
<li>Two Amazon S3 buckets: 

<ul>
<li><strong>RiderPhotoS3Bucket</strong> stores the photos uploaded by the riders</li>
<li>A few test images will be copied into the <strong>RiderPhotoS3Bucket</strong>  bucket</li>
<li><strong>ThumbnailS3Bucket</strong> stores the resized thumbnails of the rider photos</li>
</ul></li>
<li>One Amazon DynamoDB table <strong>RiderPhotoDDBTable</strong> that stores the metadata of the rider&#39;s photo with rider&#39;s profile</li>
<li>AWS Lambda functions that performs the processing steps</li>
</ul>

<p>Click on the link for the region you have chosen:  </p>

<table>
<thead>
<tr>
<th>Region</th>
<th>Launch</th>
</tr>
</thead>

<tbody>
<tr>
<td>US East (N. Virginia)</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=wildrydes-step-module-resources&amp;templateURL=https://s3.amazonaws.com/wild-rydes-step-module-us-east-1/0-cfn/wild-rydes-step-module-us-east-1.output.yaml"><img src="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/images/cloudformation-launch-stack-button.png" alt="Launch Module in us-east-1"></a></td>
</tr>
<tr>
<td>US West (Oregon)</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/new?stackName=wildrydes-step-module-resources&amp;templateURL=https://s3-us-west-2.amazonaws.com/wild-rydes-step-module-us-west-2/0-cfn/wild-rydes-step-module-us-west-2.output.yaml"><img src="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/images/cloudformation-launch-stack-button.png" alt="Launch Module in us-west-2"></a></td>
</tr>
<tr>
<td>EU (Ireland)</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/new?stackName=wildrydes-step-module-resources&amp;templateURL=https://s3-eu-west-1.amazonaws.com/wild-rydes-step-module-eu-west-1/0-cfn/wild-rydes-step-module-eu-west-1.output.yaml"><img src="http://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/images/cloudformation-launch-stack-button.png" alt="Launch Module 1 in eu-west-1"></a></td>
</tr>
</tbody>
</table>

<p><details>
<summary><strong>AWS CloudFormation Launch Instructions (expand for details)</strong></summary><p></p>

<ol>
<li><p>Click the <strong>Launch Stack</strong> link above for the region of your choice.</p></li>
<li><p>Click <strong>Next</strong> on the Select Template page.</p></li>
<li><p>On the Specify Details page, leave all the defaults and click <strong>Next</strong>.</p></li>
<li><p>On the Options page, leave all the defaults and click <strong>Next</strong>.</p></li>
<li><p>On the Review page, Click the checkboxes to give AWS CloudFormation permission to <strong>&quot;create IAM resources&quot;</strong> and <strong>&quot;create IAM resources with custom names&quot;</strong></p></li>
<li><p>Click <strong>&quot;Create Change Set&quot;</strong> in the Transforms section</p></li>
<li><p>Click <strong>&quot;Execute&quot;</strong></p></li>
<li><p>Wait for the <code>wildrydes-step-module-resources</code> stack to reach a status of <code>CREATE_COMPLETE</code>.</p></li>
<li><p>With the <code>wildrydes-step-module-resources</code> stack selected, click on the <strong>Outputs</strong> tab. These resources will be referenced in the later steps. </p></li>
</ol>

<p></p></details></p>

<h3 id="toc_5">3. Create an initial AWS Step Functions state machine</h3>

<p>After the riders upload their photo, the first thing we need do in our processing pipeline is to run a face detection algorithm on it to verify that it has a recognizable face in the photo (zero or multiple faces in the photo doesn&#39;t help unicorns recognize the rider) and the face is not wearing sunglasses (makes it harder to identify the rider). If these validations fail, notify the user and end the workflow.</p>

<p>The AWS Lambda function that implements this check by leveraging the <strong>Amazon Rekognition</strong> deep-learning based image analysis API is already deployed by AWS CloudFormation in the previous step. Look in the <strong>Outputs</strong> section for <code>FaceDetectionFunctionArn</code> for the ARN of the Lambda function. </p>

<p>The AWS Lambda function to be called when the validations fail is deployed by the AWS CloudFormation called <code>NotificationPlaceholderFunction</code>. The intent behind this step is to notify the user the photo validation failed and the error reason, so they can try upload a different photo. To keep this workshop module short, the function just prepares the message instead of actually sending the message (feel free to modify the code to send email notifications through SES)</p>

<p>Now you can create an AWS Step Functions State Machine with the initial face detection step: </p>

<p><img src="./images/1st-state-machine-graph.png" alt="initial state machine diagram"></p>

<p><details>
<summary><strong>Step-by-step instructions (expand for details)</strong></summary><p></p>

<ol>
<li><p>AWS Step Functions state machine flows are defined by a JSON document. In your favorite text editor, create a file called <code>rider-photo-state-machine.json</code></p></li>
<li><p>copy and paste the following into your JSON file:</p>

<div><pre><code class="language-JSON">{
  &quot;Comment&quot;: &quot;Rider photo processing workflow&quot;,
  &quot;StartAt&quot;: &quot;FaceDetection&quot;,
  &quot;States&quot;: {
    &quot;FaceDetection&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;REPLACE_WITH_FaceDetectionFunctionArn&quot;,
      &quot;ResultPath&quot;: &quot;$.detectedFaceDetails&quot;,
      &quot;End&quot;: true,
      &quot;Catch&quot;: [
        {
          &quot;ErrorEquals&quot;: [
            &quot;PhotoDoesNotMeetRequirementError&quot;
          ],
          &quot;ResultPath&quot;: &quot;$.errorInfo&quot;,
          &quot;Next&quot;: &quot;PhotoDoesNotMeetRequirement&quot;
        }
      ]
    },
    &quot;PhotoDoesNotMeetRequirement&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;REPLACE_WITH_NotificationPlaceholderFunctionArn&quot;,
      &quot;End&quot;: true
    }
  }
}
</code></pre></div>

<blockquote>
<p>The above JSON defines a state machine using the <a href="https://states-language.net/spec.html">Amazon States Language</a>. Take a moment to understand its structure. </p>

<p>When this state machine is launched, the AWS Step Functions interpreter begins execution by identifying the Start State. It executes that state, and then checks to see if the state is marked as an End State. If it is, the machine terminates and returns a result. If the state is not an End State, the interpreter looks for a “Next” field to determine what state to run next; it repeats this process until it reaches a Terminal State (Succeed, Fail, or an End State) or a runtime error occurs.</p>

<p>The <code>ResultPath</code> parameter in the <code>FaceDetection</code> state causes the output of the state to be the union of the original input passed to the state and an additional <code>detectedFaceDetails</code> field that holds the output from the AWS Lambda function.</p>

<p>The <code>Catch</code> parameter in the <code>FaceDetection</code> state can match custom error types thrown by the AWS Lambda function and change the flow of the execution based on the error type caught. </p>
</blockquote></li>
<li><p>Replace the <code>REPLACE_WITH_FaceDetectionFunctionArn</code> in the JSON with the ARN of the face detection AWS Lambda function </p>

<blockquote>
<p>To find the ARN of the face detection AWS Lambda function, in the AWS CloudFormation Console, go to the <code>wildrydes-step-module-resources</code> stack, look in the <strong>Outputs</strong> section for <code>FaceDetectionFunctionArn</code>)</p>
</blockquote></li>
<li><p>Replace the <code>REPLACE_WITH_NotificationPlaceholderFunctionArn</code> in the JSON with the ARN of the AWS Lambda function that mocks sending user notifications.</p>

<blockquote>
<p>To find the ARN of the mock notification AWS Lambda function, in the AWS CloudFormation Console, go to the <code>wildrydes-step-module-resources</code> stack, look in the <strong>Outputs</strong> section for <code>NotificationPlaceholderFunctionArn</code>)</p>
</blockquote></li>
<li><p>From the AWS Management Console, choose <strong>Services</strong> then select <strong>Step Functions</strong> </p></li>
<li><p>You might see the Get Started page if you have not used AWS Step Functions before. If that&#39;s the case, click <strong>Get Started</strong>, it should lead you to the page to create a new State Machine. Otherwise, click the <strong>Create a State Machine</strong> button. </p></li>
<li><p>Type <code>RiderPhotoProcessing-1</code> for the state machine name</p></li>
<li><p>Paste in the JSON from your <code>rider-photo-state-machine.json</code> file into the <strong>Code</strong> editor portion  </p></li>
<li><p>You can click on the &#x21ba; sign next to <strong>Preview</strong> to visualize the workflow:</p>

<p><img src="./images/create-initial-state-machine-2.png" alt="create initial state machine"></p></li>
<li><p>Click <strong>Create State Machine</strong> to create the state machine.</p></li>
<li><p>In the pop-up window, select the IAM role automatically generated for you (the name should look like <code>StatesExecutionRole-{region-name}</code></p>

<p><img src="./images/pick-state-role.png" alt="pick IAM role for state machine"></p></li>
<li><p>Click the <strong>New execution</strong> button to start a new execution</p></li>
<li><p>Here you specify the input data passed into the AWS Step Functions State machine to process. You can specify an unique ID in the &quot;execution id&quot; field on the top, or leave it blank (if left blank, one unique ID will be automatically generated for you). For the input data, type in the follow JSON. Make sure to substitute the <code>s3Bucket</code> and <code>userId</code> field with your own values. </p>

<p>For <code>s3Bucket</code> field, look in the <strong>Outputs</strong> section of the <code>wildrydes-step-module-resources</code> stack for <code>RiderPhotoS3Bucket</code>. Use that value in the JSON below:</p>

<div><pre><code class="language-JSON">{
  &quot;userId&quot;: &quot;REPLACE_WITH_YOUR_TEST_USERNAME&quot;,
  &quot;s3Bucket&quot;: &quot;REPLACE_WITH_YOUR_BUCKET_NAME&quot;,
  &quot;s3Key&quot;: &quot;1_happy_face.jpg&quot;
} </code></pre></div>

<blockquote>
<p>this tells the image processing workflow the userId that uploaded the picture and the Amazon S3 bucket and keys the photo is at.  </p>
</blockquote>

<p><img src="./images/test-execution-1.png" alt="test new execution"></p></li>
<li><p>You can now see the state machine execution in action. Explore the different tabs in the Console to see what information is available to you for this execution:</p>

<p><img src="./images/1st_execution_result.png" alt="1st execution result"></p></li>
<li><p>Create another execution by passing in the s3 key of a photo that wears sunglasses, see how the execution differs:  </p>

<div><pre><code class="language-JSON">{
  &quot;userId&quot;: &quot;REPLACE_WITH_YOUR_TEST_USERNAME&quot;,
  &quot;s3Bucket&quot;: &quot;REPLACE_WITH_YOUR_BUCKET_NAME&quot;,
  &quot;s3Key&quot;: &quot;2_sunglass_face.jpg&quot;
} </code></pre></div>

<p><img src="./images/initial-machine-sunglasses.png" alt="sunglasses execution result">
</p></details></p></li>
</ol>

<h3 id="toc_6">4. Add steps to prevent duplication and add face to index</h3>

<p>If the uploaded photo has passed the basic face detection checks, the next step is to ensure the face has not been stored in our collection already to prevent the same user from signing up multiple times. In this section, you will add a <strong>CheckFaceDuplicate</strong> step to your state machine by leveraging the <code>FaceSearchFunction</code> AWS Lambda function.</p>

<p><img src="./images/2nd-state-machine-graph.png" alt="2nd state machine diagram"></p>

<p><details>
<summary><strong>Step-by-step instructions (expand for details)</strong></summary><p></p>

<ol>
<li><p>Edit your <code>rider-photo-state-machine.json</code> file to add a new step to the workflow. </p>

<p>First, add a new state <code>CheckFaceDuplicate</code> following the <code>PhotoDoesNotMeetRequirement</code> state. Replace the <code>REPLACE_WITH_FaceSearchFunctionArn</code> with the <code>FaceSearchFunctionArn</code> from the AWS CloudFormation output: </p>

<div><pre><code class="language-JSON">,
&quot;CheckFaceDuplicate&quot;: {
  &quot;Type&quot;: &quot;Task&quot;,
  &quot;Resource&quot;: &quot;REPLACE_WITH_FaceSearchFunctionArn&quot;,
  &quot;ResultPath&quot;: null,
  &quot;End&quot;: true,
  &quot;Catch&quot;: [
    {
      &quot;ErrorEquals&quot;: [
        &quot;FaceAlreadyExistsError&quot;
      ],
      &quot;ResultPath&quot;: &quot;$.errorInfo&quot;,
      &quot;Next&quot;: &quot;PhotoDoesNotMeetRequirement&quot;
    }
  ]
}</code></pre></div></li>
<li><p>Find the line in the <code>FaceDetection</code> state that marks it as the End state of the state machine</p>

<div><pre><code class="language-JSON">         &quot;End&quot;: true,
</code></pre></div>

<p>and replace it with</p>

<div><pre><code class="language-JSON">        &quot;Next&quot;: &quot;CheckFaceDuplicate&quot;,
</code></pre></div>

<p>This tells AWS Step Functions if the  <code>FaceDetection</code> state runs successfully, go on to run the <code>CheckFaceDuplicate</code> state as the next step in the process. </p></li>
<li><p>At this point, your <code>rider-photo-state-machine.json</code> file should look like this (the AWS Lambda ARNs are examples): 
<details>
<summary><strong>(expand to see)</strong></summary><p></p>

<div><pre><code class="language-JSON">{
  &quot;Comment&quot;: &quot;Rider photo processing workflow&quot;,
  &quot;StartAt&quot;: &quot;FaceDetection&quot;,
  &quot;States&quot;: {
    &quot;FaceDetection&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-FaceDetectionFunction-4AYSKX2EGPV0&quot;,
      &quot;ResultPath&quot;: &quot;$.detectedFaceDetails&quot;,
      &quot;Next&quot;: &quot;CheckFaceDuplicate&quot;,
      &quot;Catch&quot;: [
        {
          &quot;ErrorEquals&quot;: [
            &quot;PhotoDoesNotMeetRequirementError&quot;
          ],
          &quot;ResultPath&quot;: &quot;$.errorInfo&quot;,
          &quot;Next&quot;: &quot;PhotoDoesNotMeetRequirement&quot;
        }
      ]
    },
    &quot;PhotoDoesNotMeetRequirement&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-NotificationPlaceholderFunct-CDRLZC8BRFWP&quot;,
      &quot;End&quot;: true
    },
    &quot;CheckFaceDuplicate&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-FaceSearchFunction-1IT67V4J214DC&quot;,
      &quot;ResultPath&quot;: null,
      &quot;End&quot;: true,
      &quot;Catch&quot;: [
        {
          &quot;ErrorEquals&quot;: [
            &quot;FaceAlreadyExistsError&quot;
          ],
          &quot;ResultPath&quot;: &quot;$.errorInfo&quot;,
          &quot;Next&quot;: &quot;PhotoDoesNotMeetRequirement&quot;
        }
      ]
    }
  }
}</code></pre></div>

<p></p></details></p></li>
<li><p>Go back the AWS Step Functions Console, create a new state machine <code>RiderPhotoProcessing-2</code> by copy-pasting the updated JSON definition:</p>

<p><img src="./images/create-machine-with-dedup.png" alt="create state machine with dedup step"></p>

<blockquote>
<p><strong>Note</strong>: AWS Step Functions state machines are immutable. Therefore, every time you want to change the state machine definition, you must always create a new state machine. </p>
</blockquote></li>
<li><p>Test the new state machine with the test input you&#39;ve used before:</p>

<div><pre><code class="language-JSON">{
  &quot;userId&quot;: &quot;REPLACE_WITH_YOUR_TEST_USERNAME&quot;,
  &quot;s3Bucket&quot;: &quot;REPLACE_WITH_YOUR_BUCKET_NAME&quot;,
  &quot;s3Key&quot;: &quot;1_happy_face.jpg&quot;
} </code></pre></div>

<blockquote>
<p>Because we haven&#39;t added the step yet to index the face in the photo into the Rekognition collection, the <code>CheckFaceDuplicate</code> step will always succeed at this point. </p>
</blockquote></li>
</ol>

<p></p></details></p>

<h3 id="toc_7">5. Add parallel processing step</h3>

<p>If the uploaded photo passes both the <code>FaceDetection</code> and <code>CheckFaceDuplicate</code> stage, we can now proceed to index the rider&#39;s face and resize the photo for displaying in the app. Since these two steps don&#39;t depend on one another, they can be run in parallel. We will add a Parallel state in AWS Step Functions to run these steps. </p>

<p>The ARNs of the two AWS Lambda functions that performs face index and generate thumbnails can be found in the AWS CloudFormation output <code>IndexFaceFunctionArn</code> and <code>ThumbnailFunctionArn</code> respectively. </p>

<p><img src="./images/3rd-state-machine-graph.png" width="60%"></p>

<p><details>
<summary><strong>Step-by-step instructions (expand for details)</strong></summary><p></p>

<ol>
<li><p>Edit your <code>rider-photo-state-machine.json</code> file to add a parallel step (with two sub-steps) to the workflow. </p>

<p>First, add a new state <code>ParallelProcessing</code> following the <code>CheckFaceDuplicate</code> state. Also make sure:</p>

<ul>
<li>  Replace the <code>REPLACE_WITH_IndexFaceFunctionArn</code> with the <code>IndexFaceFunctionArn</code> from the AWS CloudFormation output</li>
<li>  Replace the <code>REPLACE_WITH_ThumbnailFunctionArn</code> with the <code>ThumbnailFunctionArn</code> from the AWS CloudFormation output </li>
</ul>

<div><pre><code class="language-JSON">,
&quot;ParallelProcessing&quot;: {
  &quot;Type&quot;: &quot;Parallel&quot;,
  &quot;Branches&quot;: [
    {
      &quot;StartAt&quot;: &quot;AddFaceToIndex&quot;,
      &quot;States&quot;: {
        &quot;AddFaceToIndex&quot;: {
          &quot;Type&quot;: &quot;Task&quot;,
          &quot;Resource&quot;: &quot;REPLACE_WITH_IndexFaceFunctionArn&quot;,
          &quot;End&quot;: true
        }
      }
    },
    {
      &quot;StartAt&quot;: &quot;Thumbnail&quot;,
      &quot;States&quot;: {
        &quot;Thumbnail&quot;: {
          &quot;Type&quot;: &quot;Task&quot;,
          &quot;Resource&quot;: &quot;REPLACE_WITH_ThumbnailFunctionArn&quot;,
          &quot;End&quot;: true
        }
      }
    }
  ],
  &quot;End&quot;: true
}</code></pre></div></li>
<li><p>Find the line in the <code>CheckFaceDuplicate</code> state that marks it as the End state of the state machine</p>

<div><pre><code class="language-JSON">         &quot;End&quot;: true,
</code></pre></div>

<p>and replace it with</p>

<div><pre><code class="language-JSON">        &quot;Next&quot;: &quot;ParallelProcessing&quot;,
</code></pre></div>

<p>This tells AWS Step Functions if the  <code>CheckFaceDuplicate</code> state runs successfully, go on to run the <code>ParallelProcessing</code> state as the next step in the process. </p></li>
<li><p>At this point, your <code>rider-photo-state-machine.json</code> file should look like this (the AWS Lambda ARNs are examples): 
<details>
<summary><strong>(expand to see)</strong></summary><p></p>

<div><pre><code class="language-JSON">{
  &quot;Comment&quot;: &quot;Rider photo processing workflow&quot;,
  &quot;StartAt&quot;: &quot;FaceDetection&quot;,
  &quot;States&quot;: {
    &quot;FaceDetection&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-FaceDetectionFunction-4AYSKX2EGPV0&quot;,
      &quot;ResultPath&quot;: &quot;$.detectedFaceDetails&quot;,
      &quot;Next&quot;: &quot;CheckFaceDuplicate&quot;,
      &quot;Catch&quot;: [
        {
          &quot;ErrorEquals&quot;: [
            &quot;PhotoDoesNotMeetRequirementError&quot;
          ],
          &quot;ResultPath&quot;: &quot;$.errorInfo&quot;,
          &quot;Next&quot;: &quot;PhotoDoesNotMeetRequirement&quot;
        }
      ]
    },
    &quot;PhotoDoesNotMeetRequirement&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-NotificationPlaceholderFunct-CDRLZC8BRFWP&quot;,
      &quot;End&quot;: true
    },
    &quot;CheckFaceDuplicate&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-FaceSearchFunction-1IT67V4J214DC&quot;,
      &quot;ResultPath&quot;: null,
      &quot;Next&quot;: &quot;ParallelProcessing&quot;,
      &quot;Catch&quot;: [
        {
          &quot;ErrorEquals&quot;: [
            &quot;FaceAlreadyExistsError&quot;
          ],
          &quot;ResultPath&quot;: &quot;$.errorInfo&quot;,
          &quot;Next&quot;: &quot;PhotoDoesNotMeetRequirement&quot;
        }
      ]
    },
    &quot;ParallelProcessing&quot;: {
      &quot;Type&quot;: &quot;Parallel&quot;,
      &quot;Branches&quot;: [
        {
          &quot;StartAt&quot;: &quot;AddFaceToIndex&quot;,
          &quot;States&quot;: {
            &quot;AddFaceToIndex&quot;: {
              &quot;Type&quot;: &quot;Task&quot;,
              &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-IndexFaceFunction-15658V8WUI67V&quot;,
              &quot;End&quot;: true
            }
          }
        },
        {
          &quot;StartAt&quot;: &quot;Thumbnail&quot;,
          &quot;States&quot;: {
            &quot;Thumbnail&quot;: {
              &quot;Type&quot;: &quot;Task&quot;,
              &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-ThumbnailFunction-A30TCJMIG0U8&quot;,
              &quot;End&quot;: true
            }
          }
        }
      ],
      &quot;ResultPath&quot;: &quot;$.parallelResult&quot;,
      &quot;End&quot;: true
    }
  }
}</code></pre></div>

<p></p></details></p></li>
<li><p>Go back the AWS Step Functions Console, create a new state machine <code>RiderPhotoProcessing-3</code> by copy-pasting the updated JSON definition:</p>

<p><img src="./images/create-machine-with-parallel.png" alt="create state machine with parallel step"></p>

<blockquote>
<p><strong>Note</strong>: AWS Step Functions state machines are immutable. Therefore, every time you want to change the state machine definition, you must always create a new state machine. </p>
</blockquote></li>
<li><p>Test the new state machine with the test input you&#39;ve used before:</p>

<div><pre><code class="language-JSON">{
  &quot;userId&quot;: &quot;REPLACE_WITH_YOUR_TEST_USERNAME&quot;,
  &quot;s3Bucket&quot;: &quot;REPLACE_WITH_YOUR_BUCKET_NAME&quot;,
  &quot;s3Key&quot;: &quot;1_happy_face.jpg&quot;
} </code></pre></div></li>
<li><p>If last step succeeds, you can use the AWS CLI to check the list of faces indexed in your Rekognition collection (replace the <code>REPLACE_WITH_YOUR_CHOSEN_AWS_REGION</code> portion with the region string of your chosen region):</p>

<div><pre><code class="language-none">aws rekognition list-faces --collection-id rider-photos --region REPLACE_WITH_YOUR_CHOSEN_AWS_REGION</code></pre></div>

<blockquote>
<p>You might find the <code>delete-faces</code> command useful when testing</p>
</blockquote>

<div><pre><code class="language-none">aws rekognition delete-faces --collection-id rider-photos --face-ids REPLACE_WITH_ID_OF_FACE_TO_DELETE --region REPLACE_WITH_YOUR_CHOSEN_AWS_REGION</code></pre></div></li>
<li><p>You can also use the Amazon S3 Management Console to check the Amazon S3 bucket you created to store the resized thumbnail images, you should find resized thumbnail images in the bucket.</p></li>
<li><p>What happens if you start a new workflow with a different <code>userId</code> but the same s3key and s3bucket parameters?  </p></li>
</ol>

<p></p></details></p>

<h3 id="toc_8">6. Add metadata persistence step</h3>

<p>The last step of our image processing workflow is persist the metadata of the profile photo with the user&#39;s profile.</p>

<p>The ARN of the AWS Lambda function that persists the metadata can be found in the in AWS CloudFormation output <code>PersistMetadataFunctionArn</code>.</p>

<p><img src="./images/4th-state-machine-graph.png" width="60%"></p>

<p><details>
<summary><strong>Step-by-step instructions (expand for details)</strong></summary><p></p>

<ol>
<li><p>Edit your <code>rider-photo-state-machine.json</code> file to add the final persistence step. </p>

<p>First, add a new state <code>PersistMetadata</code> following the <code>ParallelProcessing</code> state. Also make sure:</p>

<ul>
<li>  Replace the <code>REPLACE_WITH_PersistMetadataFunctionArn</code> with the <code>PersistMetadataFunctionArn</code> from the AWS CloudFormation output</li>
</ul>

<div><pre><code class="language-JSON">    ,
    &quot;PersistMetadata&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;REPLACE_WITH_PersistMetadataFunctionArn&quot;,
      &quot;ResultPath&quot;: null,
      &quot;End&quot;: true
    }
</code></pre></div></li>
<li><p>Find the line in the <code>ParallelProcessing</code> state that marks it as the End state of the state machine</p>

<div><pre><code class="language-JSON">         &quot;End&quot;: true,
</code></pre></div>

<p>and replace it with</p>

<div><pre><code class="language-JSON">        &quot;Next&quot;: &quot;PersistMetadata&quot;,
</code></pre></div>

<blockquote>
<p><strong>Note</strong>: be careful to edit the <code>&quot;End&quot;</code> line at the <code>ParallelProcessing</code> level, not the individual branch level within the parallel state. </p>
</blockquote>

<p>This tells AWS Step Functions if the  <code>ParallelProcessing</code> state runs successfully, go on to run the <code>PersistMetadata</code> state as the next step in the process. </p></li>
<li><p>At this point, your <code>rider-photo-state-machine.json</code> file should look like this (the AWS Lambda ARNs are examples): 
<details>
<summary><strong>(expand to see)</strong></summary><p></p>

<div><pre><code class="language-JSON">{
  &quot;Comment&quot;: &quot;Rider photo processing workflow&quot;,
  &quot;StartAt&quot;: &quot;FaceDetection&quot;,
  &quot;States&quot;: {
    &quot;FaceDetection&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-FaceDetectionFunction-4AYSKX2EGPV0&quot;,
      &quot;ResultPath&quot;: &quot;$.detectedFaceDetails&quot;,
      &quot;Next&quot;: &quot;CheckFaceDuplicate&quot;,
      &quot;Catch&quot;: [
        {
          &quot;ErrorEquals&quot;: [
            &quot;PhotoDoesNotMeetRequirementError&quot;
          ],
          &quot;ResultPath&quot;: &quot;$.errorInfo&quot;,
          &quot;Next&quot;: &quot;PhotoDoesNotMeetRequirement&quot;
        }
      ]
    },
    &quot;PhotoDoesNotMeetRequirement&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-NotificationPlaceholderFunct-CDRLZC8BRFWP&quot;,
      &quot;End&quot;: true
    },
    &quot;CheckFaceDuplicate&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-FaceSearchFunction-1IT67V4J214DC&quot;,
      &quot;ResultPath&quot;: null,
      &quot;Next&quot;: &quot;ParallelProcessing&quot;,
      &quot;Catch&quot;: [
        {
          &quot;ErrorEquals&quot;: [
            &quot;FaceAlreadyExistsError&quot;
          ],
          &quot;ResultPath&quot;: &quot;$.errorInfo&quot;,
          &quot;Next&quot;: &quot;PhotoDoesNotMeetRequirement&quot;
        }
      ]
    },
    &quot;ParallelProcessing&quot;: {
      &quot;Type&quot;: &quot;Parallel&quot;,
      &quot;Branches&quot;: [
        {
          &quot;StartAt&quot;: &quot;AddFaceToIndex&quot;,
          &quot;States&quot;: {
            &quot;AddFaceToIndex&quot;: {
              &quot;Type&quot;: &quot;Task&quot;,
              &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-IndexFaceFunction-15658V8WUI67V&quot;,
              &quot;End&quot;: true
            }
          }
        },
        {
          &quot;StartAt&quot;: &quot;Thumbnail&quot;,
          &quot;States&quot;: {
            &quot;Thumbnail&quot;: {
              &quot;Type&quot;: &quot;Task&quot;,
              &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-ThumbnailFunction-A30TCJMIG0U8&quot;,
              &quot;End&quot;: true
            }
          }
        }
      ],
      &quot;ResultPath&quot;: &quot;$.parallelResult&quot;,
      &quot;Next&quot;: &quot;PersistMetadata&quot;
    },
    &quot;PersistMetadata&quot;: {
      &quot;Type&quot;: &quot;Task&quot;,
      &quot;Resource&quot;: &quot;arn:aws:lambda:us-west-2:012345678912:function:wild-ryde-step-module-PersistMetadataFunction-9PDCT2DT7K70&quot;,
      &quot;ResultPath&quot;: null,
      &quot;End&quot;: true
    }
  }
}   </code></pre></div>

<p></p></details></p></li>
<li><p>Go back the AWS Step Functions Console, create a new state machine <code>RiderPhotoProcessing-4</code> by copy-pasting the updated JSON definition:</p>

<p><img src="./images/create-machine-with-persistence.png" alt="create state machine with persistence step"></p></li>
<li><p>Test the new state machine with test input:</p>

<div><pre><code class="language-JSON">{
  &quot;userId&quot;: &quot;REPLACE_WITH_YOUR_TEST_USERNAME&quot;,
  &quot;s3Bucket&quot;: &quot;REPLACE_WITH_YOUR_BUCKET_NAME&quot;,
  &quot;s3Key&quot;: &quot;1_happy_face.jpg&quot;
} </code></pre></div>

<p>If you reference an image that&#39;s already indexed when you were testing the previous state machine, the execution would fail the <code>CheckFaceDuplicate</code> step like this:
<img src="./images/already-indexed-face.png" alt="already indexed face"></p>

<p>You can use the <code>aws rekognition list-faces</code> and <code>aws rekognition delete-faces</code> to clean up the previous indexed faces during testing. Or you can upload a different picture to the <code>RiderPhotoS3Bucket</code> and use the s3 key of the new picture to test. </p></li>
</ol>

<p></p></details></p>

<h2 id="toc_9">Implementation Validation</h2>

<ol>
<li>Test the final state machine (<code>RiderPhotoProcessing-4</code>) by uploading some new pictures to your  <code>RiderPhotoS3Bucket</code> Amazon S3 bucket and kick off executions in the AWS Console. </li>
</ol>

<p>Now you have built a multi-step image processing workflow using AWS Step Functions! The workflow can be integrated to your app by fronting it with AWS API Gateway or triggered from an Amazon S3 upload event.  </p>

<h2 id="toc_10">Clean-up</h2>

<ol>
<li><p>Delete the <code>RiderPhotoProcessing-*</code> state machines from the AWS Step Functions console</p>

<p><details>
<summary><strong>Step-by-step instructions (expand for details)</strong></summary><p></p>

<p>In the AWS Step Functions Management Console, go to <strong>Dashboard</strong>, select the State machine to delete, then click <strong>Delete</strong></p>

<p><img src="./images/delete-machines.png" alt="delete state machines"> </p>

<p></p></details></p></li>
<li><p>Empty the Amazon S3 buckets used to store rider images and thumbnails</p>

<p><details>
<summary><strong>Step-by-step instructions (expand for details)</strong></summary><p></p>

<ol>
<li><p>In the Amazon S3 Management Console, click on the <img src="./images/bucket-icon.png" alt=""> icon next to Amazon S3 bucket used to store rider photos (The S3 bucket should have a name similar to <code>wildrydes-step-module-resource-riderphotos3bucket-7l698ggkdcf3</code>)</p>

<p><img src="./images/s3-console-select-bucket.png" alt="select bucket"> </p></li>
<li><p>Click on the <strong>Empty Bucket</strong> button</p>

<p><img src="./images/s3-console-empty-bucket.png" alt="empty bucket"></p></li>
<li><p>Copy/paste the bucket name into the pop-up box, then click <strong>Confirm</strong></p>

<p><img src="./images/s3-empty-bucket-dialog.png" alt="empty bucket"></p></li>
<li><p>Repeat the steps to empty the Amazon S3 bucket used to store photo thumbnails (it should have a name similar to <code>wildrydes-step-module-resources-thumbnails3bucket-1j0t3m28k7mxo</code>)</p></li>
</ol>

<p></p></details></p></li>
<li><p>Delete the <code>wildrydes-step-module-resources</code> AWS CloudFormation stack that launched the AWS Lambda functions, Amazon S3 buckets and Amazon DynamoDB table</p>

<p><details>
<summary><strong>Step-by-step instructions (expand for details)</strong></summary><p></p>

<ol>
<li><p>In the AWS CloudFormation Management Console, select the <code>wildrydes-step-module-resources</code> stack</p></li>
<li><p>Select <strong>Delete Stack</strong> under <strong>Actions</strong></p>

<p><img src="./images/cloudformation-delete.png" alt="delete cloudformation stack"></p></li>
<li><p>Click <strong>Yes, Delete</strong></p></li>
</ol>

<p></p></details></p></li>
<li><p>Delete the Amazon Rekognition collection</p>

<p><details>
<summary><strong>Step-by-step instructions (expand for details)</strong></summary><p></p>

<ol>
<li><p>In a terminal window, run the following command and replace the <code>REPLACE_WITH_YOUR_CHOSEN_AWS_REGION</code> portion with the AWS region you have used. </p>

<div><pre><code class="language-none">aws rekognition delete-collection --region REPLACE_WITH_YOUR_CHOSEN_AWS_REGION --collection-id rider-photos</code></pre></div>

<p>For example:</p>

<div><pre><code class="language-none">aws rekognition delete-collection --region us-east-1 --collection-id rider-photos
aws rekognition delete-collection --region us-west-2 --collection-id rider-photos
aws rekognition delete-collection --region eu-west-1 --collection-id rider-photos</code></pre></div></li>
<li><p>If successful, you should get an acknowledgment from the service that looks like:</p>

<div><pre><code class="language-none">{
    &quot;StatusCode&quot;: 200
}</code></pre></div></li>
</ol>

<p></p></details></p></li>
</ol>




</body>

</html>
